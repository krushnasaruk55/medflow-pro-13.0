<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4F46E5">
    <title>MedFlow Patient</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/patient-app.css">
</head>

<body>

    <!-- Splash Screen -->
    <div id="splash">
        <h1 style="font-size: 3rem; margin: 0;">MedFlow</h1>
        <p>Healthcare Simplified</p>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar for Desktop -->
        <aside class="desktop-nav">
            <div class="brand-logo"
                style="padding: 0 20px 20px; font-weight: 800; font-size: 1.5rem; color: var(--primary);">MedFlow</div>
            <div class="d-nav-link active" onclick="switchNav('home')">üè† Home</div>
            <div class="d-nav-link" onclick="switchNav('records')">üìÑ Records</div>
            <div class="d-nav-link" onclick="switchNav('pharmacy')">üíä Pharmacy</div>
            <div class="d-nav-link" onclick="switchNav('profile')">üë§ Profile</div>
        </aside>

        <main class="main-content">
            <!-- --- HOME TAB --- -->
            <div id="tab-home" class="screen active scroll-content">
                <div class="header">
                    <div>
                        <div class="header-subtitle">Good Morning,
                        </div>
                        <div class="header-title" id="userNameDisplay">Guest</div>
                    </div>
                </div>
                <!-- Home Content Wrapper -->
                <div class="home-grid">
                    <!-- Left Col -->
                    <div class="home-left-col">
                        <!-- Hero Search -->
                        <div class="card hero-card">
                            <h2 class="hero-title">Find your Specialist</h2>
                            <div class="search-bar"><svg width="20" height="20" viewBox="0 0 24 24">
                                    <path
                                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                                        fill="white" />
                                </svg><input type="text" class="search-input"
                                    placeholder="Doctor, Hospital, or Specialty" id="searchInput"
                                    oninput="filterHospitals(this.value)"></div>
                        </div>
                        <!-- Quick Actions -->
                        <div class="quick-grid">
                            <div class="quick-item" onclick="document.getElementById('searchInput').focus()">
                                <div class="quick-icon" style="color: #6366f1;"><svg width="24" height="24"
                                        viewBox="0 0 24 24">
                                        <path
                                            d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM17 12h-5v5h5v-5z"
                                            fill="currentColor" />
                                    </svg></div><span class="quick-label">Book</span>
                            </div>
                            <div class="quick-item" onclick="switchNav('pharmacy')">
                                <div class="quick-icon" style="color: #ec4899;"><svg width="24" height="24"
                                        viewBox="0 0 24 24">
                                        <path
                                            d="M6 13c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm-3 .5c-.28 0-.5.22-.5.5s.22.5.5.5.5-.22.5-.5-.22-.5-.5-.5zM6 5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm15 5.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM14 7c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm0-3.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zm-11 10c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zm13 5.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM14 10.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5-.5.22-.5.5.22.5.5.5zM20 13c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm0 8c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"
                                            fill="currentColor" />
                                    </svg></div><span class="quick-label">Pharmacy</span>
                            </div>
                            <div class="quick-item" onclick="switchNav('records')">
                                <div class="quick-icon" style="color: #10b981;"><svg width="24" height="24"
                                        viewBox="0 0 24 24">
                                        <path
                                            d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"
                                            fill="currentColor" />
                                    </svg></div><span class="quick-label">Records</span>
                            </div>
                            <div class="quick-item" onclick="showEmergency()">
                                <div class="quick-icon" style="color: #ef4444; background: #fee2e2;">
                                    <svg width="24" height="24" viewBox="0 0 24 24">
                                        <path
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
                                            fill="currentColor" />
                                    </svg>
                                </div><span class="quick-label">SOS</span>
                            </div>
                        </div>
                    </div>
                    <!-- Right Col -->
                    <div class="home-right-col">
                        <!-- Live Queue (Dynamic) -->
                        <div id="liveQueueWrapper" style="display: none;">
                            <div class="list-header">
                                <span class="list-title">Live Appointment</span>
                                <span class="btn-ghost" style="font-size: 0.8rem;">View Ticket</span>
                            </div>
                            <div class="card status-card">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 4px;">
                                            Current Status </div>
                                        <div style="font-weight: 700; font-size: 1.2rem; color: var(--primary);"
                                            id="queueStatusText">In Queue</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 2rem; font-weight: 800; color: var(--text-main);"
                                            id="queueMyToken">#12</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">YOUR
                                            TOKEN</div>
                                    </div>
                                </div>
                                <div
                                    style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 20px;">
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Now
                                            Serving</div>
                                        <div style="font-weight: 600; color: var(--success); font-size: 1.1rem;"
                                            id="queueCurrentToken">#8</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">Est.
                                            Wait</div>
                                        <div style="font-weight: 600; color: var(--warning); font-size: 1.1rem;"
                                            id="queueWaitTime">15m</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Hospital List -->
                        <div class="list-header">
                            <span class="list-title">Top Hospitals</span>
                            <span class="btn-ghost" style="font-size: 0.8rem;">See All</span>
                        </div>
                        <div id="hospitalsList">
                            <div style="text-align: center; color: var(--text-muted);">Loading
                                hospitals...</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Responsive Layout Handled via CSS -->
            <!-- --- RECORDS TAB --- -->
            <div id="tab-records" class="screen scroll-content">
                <div class="header">
                    <div class="header-title">My Records</div>
                </div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px;"><button class="btn btn-block"
                        id="btn-tab-appointments" onclick="showRecordType('appointments')">Appointments</button><button
                        class="btn btn-outline btn-block" id="btn-tab-labs" onclick="showRecordType('labs')">Lab
                        Reports</button></div>
                <div id="appointmentsListWrapper">
                    <!-- Appointment list injected here -->
                </div>
                <div id="labListWrapper" style="display: none;">
                    <!-- Lab list injected here -->
                </div>
            </div>
            <!-- --- PHARMACY TAB --- -->
            <div id="tab-pharmacy" class="screen scroll-content">
                <div class="header">
                    <div class="header-title">Pharmacy</div><button class="btn btn-sm" onclick="openOrderModal()">+New
                        Order</button>
                </div>
                <div class="card" style="background: #e0f2fe; border: none; color: #0369a1;">
                    <h3 style="margin: 0 0 8px 0;">Order Medicines</h3>
                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.8;">Upload your prescription or type the
                        medicines you need. We'll handle the rest.</p>
                </div>
                <div class="list-header"><span class="list-title">Order History</span></div>
                <div id="pharmacyList">
                    <!-- Pharmacy orders -->
                </div>
            </div>
            <!-- --- PROFILE TAB --- -->
            <div id="tab-profile" class="screen scroll-content">
                <div class="header">
                    <div class="header-title">Profile</div><button class="btn btn-ghost" style="color: var(--danger);"
                        onclick="logout()">Logout</button>
                </div>
                <div class="card" style="text-align: center; padding: 30px;">
                    <div class="avatar" style="width: 80px; height: 80px; margin: 0 auto 16px; font-size: 2rem;">üë§
                    </div>
                    <h2 style="margin: 0;" id="profileName">Guest User</h2>
                    <p style="color: var(--text-muted); margin-top: 4px;" id="profilePhone">+91 -----</p>
                </div>
                <div class="card">
                    <h3 style="margin-top: 0;">Personal Details</h3>
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div class="form-group"><label>Full Name</label><input type="text" class="form-input" id="pName"
                                required></div>
                        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div><label>Age</label><input type="number" class="form-input" id="pAge"></div>
                            <div><label>Gender</label><select class="form-input" id="pGender">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select></div>
                        </div>
                        <div class="form-group"><label>Address</label><input type="text" class="form-input"
                                id="pAddress">
                        </div><button type="submit" class="btn btn-block">Save
                            Changes</button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchNav('home')"><svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg><span class="nav-label">Home</span></div>
        <div class="nav-item" onclick="switchNav('records')"><svg class="nav-icon" viewBox="0 0 24 24">
                <path
                    d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
            </svg><span class="nav-label">Records</span></div>
        <div class="nav-item" onclick="switchNav('pharmacy')"><svg class="nav-icon" viewBox="0 0 24 24">
                <path
                    d="M4.5 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-2c.83 0 1.5-.67 1.5-1.5S5.33 5.5 4.5 5.5 3 6.17 3 7s.67 1.5 1.5 1.5zm15 2c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-4c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"
                    opacity="0" />
                <path d="M13 13l-3-2.25L7 13V4H6v16h12V4h-1v9zM21 4h-2v14h2V4z" />
            </svg><span class="nav-label">Pharmacy</span></div>
        <div class="nav-item" onclick="switchNav('profile')"><svg class="nav-icon" viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg><span class="nav-label">Profile</span></div>
    </nav>
    <!-- Modals -->
    <!-- Booking Modal -->
    <div id="modal-booking" class="modal">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">Book Appointment</h3><span onclick="closeModal('modal-booking')"
                    style="font-size:1.5rem; cursor:pointer;">&times;
                </span>
            </div>
            <form id="bookingForm" onsubmit="submitBooking(event)"><input type="hidden" id="bookHospitalId"><input
                    type="hidden" id="bookDoctorId" value="">
                <p id="bookHospitalName" style="color:var(--text-muted); margin-bottom:16px;">Selection</p>
                <div class="form-group"><label>Date</label><input type="date" class="form-input" id="bookDate" required>
                </div>
                <div class="form-group"><label>Time</label><input type="time" class="form-input" id="bookTime" required>
                </div>
                <div class="form-group"><label>Visit Type</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><label
                            style="border:1px solid var(--border); padding:10px; border-radius:10px; text-align:center; cursor:pointer;"
                            onclick="selectType(this, 'offline')"><input type="radio" name="visitType" value="offline"
                                checked style="display:none;">üè† In Person </label><label
                            style="border:1px solid var(--border); padding:10px; border-radius:10px; text-align:center; cursor:pointer;"
                            onclick="selectType(this, 'online')"><input type="radio" name="visitType" value="online"
                                style="display:none;">üìπ Video Call </label></div>
                </div>
                <div class="form-group"><label>Reason</label><input type="text" class="form-input" id="bookReason"
                        placeholder="Fever, Checkup..." autocomplete="off"></div><button type="submit"
                    class="btn btn-block" style="margin-top:10px;">Confirm & Book</button>
            </form>
        </div>
    </div>
    <!-- Login Modal -->
    <div id="modal-login" class="modal">
        <div class="bottom-sheet">
            <h2 id="authTitle" style="text-align: center;">Welcome Back</h2>
            <form id="authForm" onsubmit="handleAuth(event)" autocomplete="off">
                <div id="registerFields" style="display: none;">
                    <div class="form-group"><label>Full Name</label><input type="text" class="form-input" id="regName"
                            autocomplete="off">
                    </div>
                    <div class="form-group"><label>Phone</label><input type="tel" class="form-input" id="regPhone"
                            autocomplete="off">
                    </div>
                    <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>Age</label><input type="number" class="form-input" id="regAge" autocomplete="off">
                        </div>
                        <div><label>Gender</label><select class="form-input" id="regGender">
                                <option>Male</option>
                                <option>Female</option>
                            </select></div>
                    </div>
                    <div class="form-group"><label>Select Hospital</label><select class="form-input"
                            id="regHospital"></select></div>
                </div>
                <div id="loginFields">
                    <div class="form-group"><label>Phone</label><input type="tel" class="form-input" id="loginPhone"
                            required autocomplete="off"></div>
                </div>
                <div class="form-group"><label>Password</label><input type="password" class="form-input" id="authPass"
                        required autocomplete="off"></div><button type="submit" class="btn btn-block"
                    id="authBtn">Login</button>
                <p style="text-align:center; margin-top:20px; font-size:0.9rem;"><span id="authSwitchText">New
                        User?</span><a href="#" onclick="toggleAuthMode()"
                        style="color:var(--primary); font-weight:600;">Register</a></p>
            </form>
        </div>
    </div>
    <!-- Pharmacy Order Modal -->
    <div id="modal-pharmacy" class="modal">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">Order Medicines</h3><span onclick="closeModal('modal-pharmacy')"
                    style="font-size:1.5rem; cursor:pointer;">&times;
                </span>
            </div>
            <form onsubmit="submitPharmacyOrder(event)">
                <div class="form-group"><label>Prescription / Medicines</label><textarea class="form-input" rows="4"
                        id="pharmacyText" placeholder="List your medicines here..." required></textarea></div>
                <button type="submit" class="btn btn-block">Place Order</button>
            </form>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script> // --- State ---
        let user = JSON.parse(localStorage.getItem('medUser'));
        let hospitals = [];
        let socket = io();
        let isRegister = false;

        socket.on('connect', () => {
            if (user && user.hospitalId) {
                socket.emit('join-patient-room', { hospitalId: user.hospitalId });
            }
        });

        // --- Init ---
        window.addEventListener('load', async () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0'; setTimeout(() => document.getElementById('splash').style.display = 'none', 500);
            }

                , 1500);

            await fetchHospitals();

            if (user) {
                initUser();
            }

            else {
                showLogin();
            }
        });

        function initUser() {
            document.getElementById('userNameDisplay').textContent = user.name;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profilePhone').textContent = user.phone;

            // Fill profile form
            document.getElementById('pName').value = user.name || '';
            document.getElementById('pAge').value = user.age || '';
            // Match gender casing if needed
            document.getElementById('pAddress').value = user.address || '';

            loadDashboardData();

            // Socket join
            if (user.hospitalId) socket.emit('join-patient-room', {
                hospitalId: user.hospitalId
            });

            closeModal('modal-login');
        }

        async function fetchHospitals() {
            try {
                const res = await fetch('/api/hospitals');
                hospitals = await res.json();
                renderHospitals(hospitals);

                // Fill register dropdown
                const sel = document.getElementById('regHospital');
                sel.innerHTML = '';

                hospitals.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h._id;
                    opt.textContent = h.name;
                    sel.appendChild(opt);
                });
            }

            catch (e) {
                console.error(e);
            }
        }

        function renderHospitals(list) {
            const cont = document.getElementById('hospitalsList');
            cont.innerHTML = '';

            list.forEach(h => {
                const div = document.createElement('div');
                div.className = 'h-card';

                div.innerHTML = ` <div class="h-img" ></div> <div class="h-info" > <div class="h-name" >${h.name
                    }

                    </div> <div class="h-meta" >${h.address || 'Location'
                    }

                    </div> </div> <button class="btn btn-sm btn-outline" onclick="openBookingModal('${h._id}')" >Book</button> `;
                cont.appendChild(div);
            });
        }

        function filterHospitals(query) {
            const filtered = hospitals.filter(h => h.name.toLowerCase().includes(query.toLowerCase()));
            renderHospitals(filtered);
        }

        // --- Tabs ---
        function switchNav(tab) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            // Desktop nav link update
            document.querySelectorAll('.d-nav-link').forEach(n => n.classList.remove('active'));

            // Simple hack for active class based on onclick content
            // Identifying by index or manual loop is better, but let's assume order
            const indices = {
                'home': 0, 'records': 1, 'pharmacy': 2, 'profile': 3
            }

                ;
            if (document.querySelectorAll('.nav-item')[indices[tab]]) document.querySelectorAll('.nav-item')[indices[tab]].classList.add('active');
            if (document.querySelectorAll('.d-nav-link')[indices[tab]]) document.querySelectorAll('.d-nav-link')[indices[tab]].classList.add('active');

            if (tab === 'records') loadRecords();
            if (tab === 'pharmacy') loadPharmacy();
        }

        // --- Auth ---
        function showLogin() {
            document.getElementById('modal-login').classList.add('open');
        }

        function toggleAuthMode() {
            isRegister = !isRegister;
            document.getElementById('registerFields').style.display = isRegister ? 'block' : 'none';
            document.getElementById('loginFields').style.display = isRegister ? 'none' : 'block';
            document.getElementById('authTitle').textContent = isRegister ? 'Create Account' : 'Welcome Back';
            document.getElementById('authBtn').textContent = isRegister ? 'Register' : 'Login';
            document.getElementById('authSwitchText').textContent = isRegister ? 'Already have an account?' : 'New user?';
        }

        async function handleAuth(e) {
            e.preventDefault();
            const password = document.getElementById('authPass').value;
            const phone = isRegister ? document.getElementById('regPhone').value : document.getElementById('loginPhone').value;

            if (isRegister) {
                const name = document.getElementById('regName').value;
                const age = document.getElementById('regAge').value;
                const gender = document.getElementById('regGender').value;
                const hospitalId = document.getElementById('regHospital').value;

                const res = await fetch('/api/patient-app/register', {
                    method: 'POST', headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify({
                        name, phone, password, age, gender, hospitalId
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('Registered! Please login.');
                    toggleAuthMode();
                }

                else {
                    alert(data.message);
                }
            }

            else {
                const res = await fetch('/api/patient-app/login', {
                    method: 'POST', headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify({
                        phone, password
                    })
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('medUser', JSON.stringify(data.patient));
                    user = data.patient;
                    initUser();
                }

                else {
                    alert('Invalid credentials');
                }
            }
        }

        function logout() {
            localStorage.removeItem('medUser');
            location.reload();
        }

        // --- Booking ---
        function openBookingModal(hId) {
            if (!user) return showLogin();
            const h = hospitals.find(x => x._id === hId);
            document.getElementById('bookHospitalId').value = hId;
            document.getElementById('bookHospitalName').textContent = h ? h.name : 'Selected Hospital';

            // Set date to today min
            document.getElementById('bookDate').min = new Date().toISOString().split('T')[0];

            // Reset Fields
            document.getElementById('bookDate').value = '';
            document.getElementById('bookTime').value = '';
            document.getElementById('bookReason').value = '';
            const defaultType = document.querySelector('input[name="visitType"][value="offline"]');
            if (defaultType) {
                defaultType.checked = true;
                selectType(defaultType.parentElement, 'offline');
            }

            document.getElementById('modal-booking').classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        async function submitBooking(e) {
            e.preventDefault();

            const data = {
                patientId: user.id,
                hospitalId: document.getElementById('bookHospitalId').value,
                date: document.getElementById('bookDate').value,
                time: document.getElementById('bookTime').value,
                reason: document.getElementById('bookReason').value,
                type: document.querySelector('input[name="visitType"]:checked').value
            }

                ;

            try {
                const res = await fetch('/api/patient-app/book', {
                    method: 'POST', headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify(data)
                });
                const resp = await res.json();

                if (resp.success) {
                    alert('Booking Confirmed!');
                    closeModal('modal-booking');
                    loadRecords();
                    loadDashboardData();
                }

                else {
                    alert(resp.message);
                }
            }

            catch (e) {
                console.error(e);
            }
        }

        function selectType(el, val) {
            // visual selection logic if needed
            el.parentElement.querySelectorAll('label').forEach(l => l.style.borderColor = 'var(--border)');
            el.style.borderColor = 'var(--primary)';
            el.querySelector('input').checked = true;
        }

        // --- Records (Appointments & Labs) ---
        async function loadRecords() {
            if (!user) return;

            // Fetch Appointments
            const resA = await fetch(`/api/patient-app/appointments/${user.id
                }

                `);
            const dataA = await resA.json();

            const contA = document.getElementById('appointmentsListWrapper');
            contA.innerHTML = '';

            if (dataA.appointments.length === 0) contA.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px;">No appointments found</div>';

            dataA.appointments.forEach(app => {
                const div = document.createElement('div');
                div.className = 'card';

                div.innerHTML = ` <div style="display:flex; justify-content:space-between; margin-bottom:10px;" > <span style="font-weight:600;" >${new Date(app.appointmentDate).toLocaleDateString()
                    }

                    </span> <span style="color:var(--primary); font-weight:600;" >${app.status.toUpperCase()
                    }

                    </span> </div> <div style="font-size:0.9rem; color:var(--text-muted);" > <div>Doctor ID: ${app.doctorId || 'Assigned on arrival'
                    }

                    </div> <div>Reason: ${app.notes || 'General'
                    }

                    </div> ${app.videoLink ? `<a href = "${app.videoLink}" target = "_blank" class="btn btn-sm btn-outline" style = "margin-top:10px; display:inline-block;" > Join Video Call</a > ` : ''
                    }

                    </div> `;
                contA.appendChild(div);
            });

            // Try fetching labs 
            try {
                const resL = await fetch(`/api/patient-app/lab-tests/${user.id
                    }

                    `);
                const dataL = await resL.json();
                const contL = document.getElementById('labListWrapper');
                contL.innerHTML = '';

                if (dataL.tests && dataL.tests.length > 0) {
                    dataL.tests.forEach(test => {
                        const div = document.createElement('div');
                        div.className = 'card';

                        div.innerHTML = ` <div style="display:flex; justify-content:space-between; margin-bottom:8px;" > <strong style="color:var(--primary);" >${test.testName
                            }

                            </strong> <span class="status-badge" style="font-size:0.8rem;" >${test.status
                            }

                            </span> </div> <div style="color:#666; font-size:0.85rem;" >Date: ${new Date(test.orderedAt).toLocaleDateString()
                            }

                            </div> ${test.results && test.results.length > 0 ? `<div style = "margin-top:10px; background:#f9fafb; padding:10px; border-radius:8px;" > <strong>Results:</strong> ${test.results.map(r => `<div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-top:4px;" ><span>${r.parameterName
                                }

                                        </span><span>${r.value
                                }

                                        ${r.unit
                                }

                                        </span></div>`).join('')
                                }

                                </div > ` : '<div style="margin-top:5px; font-style:italic; font-size:0.8rem;">Results pending</div>'
                            }

                            `;
                        contL.appendChild(div);
                    });
                }

                else {
                    contL.innerHTML = '<div style="text-align:center;color:#ccc;margin-top:20px;">No lab records found</div>';
                }
            }

            catch (e) {
                console.error('Lab fetch error', e);
            }
        }

        function showRecordType(type) {
            document.getElementById('appointmentsListWrapper').style.display = type === 'appointments' ? 'block' : 'none';
            document.getElementById('labListWrapper').style.display = type === 'labs' ? 'block' : 'none';

            document.getElementById('btn-tab-appointments').className = type === 'appointments' ? 'btn btn-block' : 'btn btn-outline btn-block';
            document.getElementById('btn-tab-labs').className = type === 'labs' ? 'btn btn-block' : 'btn btn-outline btn-block';
        }

        // --- Pharmacy ---
        function openOrderModal() {
            document.getElementById('modal-pharmacy').classList.add('open');
        }

        async function submitPharmacyOrder(e) {
            e.preventDefault();
            if (!user || !user.hospitalId) return alert('Register with a hospital first');

            const text = document.getElementById('pharmacyText').value;

            try {
                const res = await fetch('/api/patient-app/pharmacy/order', {
                    method: 'POST', headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify({
                        patientId: user.id, hospitalId: user.hospitalId, prescription: text
                    })
                });
                const d = await res.json();

                if (d.success) {
                    alert('Order Placed');
                    closeModal('modal-pharmacy');
                    loadPharmacy();
                }
            }

            catch (e) {
                console.error(e);
            }
        }

        async function loadPharmacy() {
            if (!user) return;

            const res = await fetch(`/api/patient-app/pharmacy/orders/${user.id
                }

                `);
            const data = await res.json();
            const cont = document.getElementById('pharmacyList');
            cont.innerHTML = '';

            data.orders.forEach(o => {
                const div = document.createElement('div');
                div.className = 'card';

                div.innerHTML = ` <div style="display:flex; justify-content:space-between;" > <span style="font-weight:600;" >#${o._id.substr(-6)
                    }

                    </span> <span style="color:var(--primary);" >${o.status
                    }

                    </span> </div> <div>${o.prescription
                    }

                    </div> <div style="font-size:0.8rem; color:#888; margin-top:5px;" >${new Date(o.orderDate).toLocaleDateString()
                    }

                    </div> `;
                cont.appendChild(div);
            });
        }

        // --- Profile ---
        async function updateProfile(e) {
            e.preventDefault();
            if (!user) return;

            const update = {
                name: document.getElementById('pName').value,
                age: document.getElementById('pAge').value,
                gender: document.getElementById('pGender').value,
                address: document.getElementById('pAddress').value
            }

                ;

            const res = await fetch(`/api/patient-app/profile/${user.id
                }

                `, {
                method: 'PUT', headers: {
                    'Content-Type': 'application/json'
                }

                ,
                body: JSON.stringify(update)
            });
            const d = await res.json();

            if (d.success) {
                user = d.patient;
                localStorage.setItem('medUser', JSON.stringify(user));
                alert('Profile Updated');
                initUser();
            }
        }

        // --- Live Queue Logic ---
        async function loadDashboardData() {

            // Re-fetch appointments to find active one
            // Simplified: if we have an appt today that shouldn't be missed
            const res = await fetch(`/api/patient-app/appointments/${user.id
                }

                `);
            const data = await res.json();
            const today = new Date().toISOString().split('T')[0];
            const active = data.appointments.find(a => a.appointmentDate === today && a.status === 'scheduled'); // 'scheduled' or 'waiting'

            if (active) {
                document.getElementById('liveQueueWrapper').style.display = 'block';
                // Mock Token
                document.getElementById('queueMyToken').textContent = active.token ? '#' + active.token : 'TBD';
                document.getElementById('queueStatusText').textContent = active.token ? 'In Queue' : 'Confirmed';
            }

            else {
                document.getElementById('liveQueueWrapper').style.display = 'none';
            }
        }

        socket.on('current-token-update', (data) => {
            // Ensure we are in the right hospital context
            document.getElementById('queueCurrentToken').textContent = '#' + data.token;
            // re-calculate wait time logic here
        });

        function showEmergency() {
            alert("Emergency Service Contacted! (Demo)");
        }

    </script>
</body>

</html>